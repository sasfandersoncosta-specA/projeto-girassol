<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Encerrar Conta - Projeto Girassol</title>

    <link rel="stylesheet" href="../style.css?v=2.3">
    <link rel="stylesheet" href="psi_dashboard.css?v=2.3">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Montserrat:wght@700&display.swap" rel="stylesheet">
</head>
<body class="pagina-dashboard">

    <div class="dashboard-container">
        
        <aside class="dashboard-sidebar">
            <div class="sidebar-header"> 
                <img src="../assets/logos/logo_duplo_branco.png" alt="Logo Girassol" class="sidebar-logo">
            </div>
            <nav class="sidebar-nav">
                <ul>
                    <li><a href="psi_dashboard.html"><span>‚Üê Voltar ao Painel</span></a></li>
                </ul>
            </nav>
        </aside>

        <main class="dashboard-main">
            
            <div class="main-header" style="background-color: #E63946; margin-bottom: 30px;">
                <div class="header-content">
                    <h1 style="color: white; font-family: 'New Kansas', serif;">√â uma pena ver voc√™ partir, <span id="display-nome-psi"></span></h1>
                    <p class="subtitulo-header" style="color: rgba(255,255,255,0.9);">Sentiremos sua falta na nossa comunidade. Antes de ir, confira o impacto que voc√™ gerou na plataforma.</p>
                </div>
            </div>

            <div class="widget">
                <h3>Sua Jornada no Girassol</h3>
                <div class="exit-stats-grid">
                    <div class="exit-stat-card">
                        <div class="stat-icon">üìÖ</div>
                        <div class="stat-value" id="stat-dias">...</div>
                        <div class="stat-label">Dias com a gente</div>
                    </div>
                    <div class="exit-stat-card">
                        <div class="stat-icon">üëÅÔ∏è</div>
                        <div class="stat-value" id="stat-views">...</div>
                        <div class="stat-label">Visualiza√ß√µes de Perfil</div>
                    </div>
                    <div class="exit-stat-card">
                        <div class="stat-icon">üí¨</div>
                        <div class="stat-value" id="stat-contatos">...</div>
                        <div class="stat-label">Contatos Recebidos</div>
                    </div>
                    <div class="exit-stat-card">
                        <div class="stat-icon">‚≠ê</div>
                        <div class="stat-value" id="stat-avaliacao">5.0</div>
                        <div class="stat-label">Sua Reputa√ß√£o</div>
                    </div>
                </div>
            </div>

            <div class="widget" style="margin-top: 30px;">
                <h3>Por que voc√™ est√° nos deixando?</h3>
                <p style="margin-bottom: 20px; color: #666;">Sua opini√£o √© fundamental para melhorarmos.</p>
                
                <form id="exit-form">
                    <div class="form-group">
                        <label for="motivo-saida">Selecione o principal motivo:</label>
                        <div class="custom-select-wrapper">
                            <select id="motivo-saida" name="motivo" required style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #ccc; background: #f9f9f9;">
                                <option value="" disabled selected>Selecione uma op√ß√£o...</option>
                                <option value="custo">Achei o valor da assinatura alto</option>
                                <option value="pouco_retorno">Recebi poucos contatos de pacientes</option>
                                <option value="plataforma_dificil">Achei a plataforma dif√≠cil de usar</option>
                                <option value="migracao">Estou migrando para outra plataforma</option>
                                <option value="pausa">Vou dar uma pausa nos atendimentos</option>
                                <option value="outro">Outro motivo</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Qual nota voc√™ daria para sua experi√™ncia geral?</label>
                        <div class="rating-exit-stars">
                            <input type="radio" id="star5" name="avaliacao" value="5" /><label for="star5" title="Excelente">‚òÖ</label>
                            <input type="radio" id="star4" name="avaliacao" value="4" /><label for="star4" title="Muito Bom">‚òÖ</label>
                            <input type="radio" id="star3" name="avaliacao" value="3" /><label for="star3" title="Bom">‚òÖ</label>
                            <input type="radio" id="star2" name="avaliacao" value="2" /><label for="star2" title="Ruim">‚òÖ</label>
                            <input type="radio" id="star1" name="avaliacao" value="1" /><label for="star1" title="P√©ssimo">‚òÖ</label>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="sugestao-saida">O que poder√≠amos ter feito diferente?</label>
                        <textarea id="sugestao-saida" name="sugestao" rows="4" class="feedback-textarea" placeholder="Deixe sua sugest√£o ou cr√≠tica aqui..."></textarea>
                    </div>

                    <div class="form-group" style="margin: 30px 0; background: #fff5f5; padding: 20px; border-radius: 8px; border: 1px solid #feb2b2;">
                        <label for="senha-exclusao" style="display:block; margin-bottom:10px; font-weight:bold; color:#c53030;">
                            Digite sua senha para confirmar a exclus√£o definitiva:
                        </label>
                        <input type="password" id="senha-exclusao" name="senha" required style="width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 6px;" placeholder="Sua senha atual">
                    </div>

                    <div class="form-actions" style="display: flex; justify-content: space-between; align-items: center; margin-top: 40px; border-top: 1px solid #eee; padding-top: 20px;">
                        <a href="psi_dashboard.html" class="btn btn-secundario" style="text-decoration: none;">Desisti, quero ficar!</a>
                        <button type="submit" class="btn btn-perigo-final">Confirmar Exclus√£o</button>
                    </div>
                </form>
            </div>

        </main>
    </div>

    <div id="toast-container"></div>

    <script src="/config.js"></script>
    <script>
        // Helper de Toast
        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.textContent = message;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 4000);
        }

        document.addEventListener('DOMContentLoaded', async () => {
            const token = localStorage.getItem('girassol_token');
            if(!token) window.location.href = '../login.html';

            // --- 1. CARREGAR DADOS E NOME ---
            try {
                // Busca Stats
                const resStats = await fetch(`${API_BASE_URL}/api/psychologists/me/stats`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                // Busca Perfil (Para pegar o nome real)
                const resProfile = await fetch(`${API_BASE_URL}/api/psychologists/me`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if(resProfile.ok) {
                    const profile = await resProfile.json();
                    
                    // L√≥gica de Formata√ß√£o do Nome (Primeira letra mai√∫scula)
                    if(profile.nome) {
                        const nomes = profile.nome.split(' ');
                        const primeiroNome = nomes[0].charAt(0).toUpperCase() + nomes[0].slice(1).toLowerCase();
                        document.getElementById('display-nome-psi').textContent = primeiroNome + '!';
                    }
                }

                if(resStats.ok) {
                    const stats = await resStats.json();
                    document.getElementById('stat-dias').textContent = stats.daysActive || '32';
                    document.getElementById('stat-views').textContent = stats.profileViews || '145';
                    document.getElementById('stat-contatos').textContent = stats.contactsReceived || '12';
                }
            } catch(e) {
                console.error("Erro ao carregar dados:", e);
            }

            // --- 2. L√ìGICA DE EXCLUS√ÉO ---
            document.getElementById('exit-form').onsubmit = async (e) => {
                e.preventDefault();
                const btn = e.target.querySelector('button[type="submit"]');
                const originalText = btn.textContent;
                
                btn.disabled = true;
                btn.textContent = "Processando...";
                btn.style.opacity = "0.7";

                const senha = document.getElementById('senha-exclusao').value;
                const motivo = document.getElementById('motivo-saida').value;

                try {
                    const response = await fetch(`${API_BASE_URL}/api/psychologists/me`, {
                        method: 'DELETE',
                        headers: { 
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({ senha, motivo })
                    });

                    if (response.ok) {
                        showToast('Conta exclu√≠da com sucesso. At√© logo!', 'success');
                        localStorage.removeItem('girassol_token');
                        setTimeout(() => { window.location.href = '../index.html'; }, 2000);
                    } else {
                        const err = await response.json();
                        showToast('Erro: ' + (err.error || 'Senha incorreta'), 'error');
                        btn.disabled = false;
                        btn.textContent = originalText;
                        btn.style.opacity = "1";
                    }
                } catch (error) {
                    console.error(error);
                    showToast('Erro de conex√£o. Tente novamente.', 'error');
                    btn.disabled = false;
                    btn.textContent = originalText;
                }
            };
        });
    </script>
</body>
</html>